<!-- Windows Versions -->
<!-- We can use the Get-WmiObject cmdlet to find information about the operating system -->
<!--  This cmdlet can be used to get instances of WMI classes or information about available WMI 
    classes -->
<!-- We can easily obtain this information using the win32_OperatingSystem class, which shows that 
    we are on a Windows 10 host, build number 19041. -->
PS C:\htb> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber

Version    BuildNumber
-------    -----------
10.0.19041 19041
<!-- Some other useful classes that can be used with Get-WmiObject are Win32_Process to get a process
listing, Win32_Service to get a listing of services, and Win32_Bios to get Basic Input/Output System 
(BIOS) information. -->
<!--  We can use the ComputerName parameter to get information about remote computers. Get-WmiObject 
    can be used to start and stop services on local and remote computers, and more. -->

<!-- Accessing Windows -->
<!-- Local Access Concepts -->
<!-- Local access is the most common way to access any computer, including computers running Windows.
     Input is likely happening through a keyboard, trackpad &/or mouse. Output is coming from the 
     display screen(s) -->
<!-- Remote Access Concepts -->
<!-- Remote Access is accessing a computer over a network -->
<!-- Consider MSPs(managed service provider) & MSSPs(Managed Security Service Provider), 
    both industries are primarily dependent on managing their client's computer systems remotely. -->
<!-- Some of the most common remote access technologies include but aren't limited to: -->
<!-- Virtual Private Networks (VPN)
Secure Shell (SSH)
File Transfer Protocol (FTP)
Virtual Network Computing (VNC)
Windows Remote Management (or PowerShell Remoting) (WinRM)
Remote Desktop Protocol (RDP) -->
<!-- We will focus primarily on using RDP in this module. -->

<!-- Remote Desktop Protocol (RDP) -->
<!-- RDP uses a client/server architecture where a client-side application is used to specify a 
    computer's target IP address or hostname over a network where RDP access is enabled. -->
<!--  It is important to note that RDP listens by default on logical port 3389. Keep in mind that an 
    IP address is used as a logical identifier for a computer on a network, and a logical port is an 
    identifier assigned to an application. -->
<!-- Once a request (encapsulated inside a packet) has reached a destination computer via its IP 
    address, the request will be directed to an application hosted on the computer based on the port 
    specified in that request (included as a header inside a packet) -->
<!-- We can use RDP to connect to a Windows target from an attack host running Linux or Windows.  -->
<!-- If we are connecting to a Windows target from a Windows host, we can use the built-in RDP client
     application called Remote Desktop Connection (mstsc.exe) -->
<!-- For this to work, remote access must already be allowed on the target Windows system -->
<!-- By default, remote access is not allowed on Windows operating systems -->
<!-- Remote Desktop Connection also allows us to save connection profiles. This is a common habit 
    among IT admins because it makes connecting to remote systems more convenient. -->
<!-- As pentesters, we can benefit from looking for these saved Remote Desktop Files (.rdp) 
    while on an engagement. -->

<!-- Using xfreerdp -->
<!-- From a Linux-based attack host we can use a tool called xfreerdp to remotely access Windows 
    targets.  -->
<!-- You will notice that we use xfreerdp across multiple modules because of its ease of use, 
    feature set, command line utility, and efficiency -->
<!-- Remember that we can also copy and paste in xfreerdp commands in the command line, so we do not 
    need to enter options manually. -->
<!-- There are several options available to us with xfreerdp, such as drive redirection to be able 
    to tranfer files to/from the target host -->
<!-- Other RDP clients exist, such as Remmina and rdesktop, and we encourage you to experiment with 
    others and see what works best for you -->

<!-- Connecting to the Windows Target -->
<!-- Connect via Remote Desktop (RDP) using the following command: -->
Warstone@htb[/htb]$ xfreerdp /v:<targetIp> /u:htb-student /p:Password


<!-- Operating System Structure -->
<!-- In Windows operating systems, the root directory is <drive_letter>:\ (commonly C drive). -->
<!-- The root directory (also known as the boot partition) is where the operating system is installed -->
<!-- Other physical and virtual drives are assigned other letters, for example, Data (E:). -->
<!-- The directory structure of the boot partition is as follows: -->
<!-- Directory               	Function
     Perflogs	      Can hold Windows performance logs but is empty by default.
    Program Files	On 32-bit systems, all 16-bit and 32-bit programs are installed here. On 64-bit 
                     systems, only 64-bit programs are installed here.
 Program Files (x86)	32-bit and 16-bit programs are installed here on 64-bit editions of Windows.
   ProgramData	    This is a hidden folder that contains data that is essential for certain installed
                    programs to run. This data is accessible by the program no matter what user is 
                    running it.
      Users	        This folder contains user profiles for each user that logs onto the system and 
                    contains the two folders Public and Default.
    Default	        This is the default user profile template for all created users. Whenever a new 
                    user is added to the system, their profile is based on the Default profile.
     Public	        This folder is intended for computer users to share files and is accessible to all
                    users by default. This folder is shared over the network by default but requires a 
                    valid network account to access.
    AppData	        Per user application data and settings are stored in a hidden user subfolder 
                    (i.e., cliff.moore\AppData). Each of these folders contains three subfolders. 
                    The Roaming folder contains machine-independent data that should follow the user's
                     profile, such as custom dictionaries. The Local folder is specific to the 
                     computer itself and is never synchronized across the network. LocalLow is similar
                      to the Local folder, but it has a lower data integrity level. Therefore it can 
                      be used, for example, by a web browser set to protected or safe mode.
    Windows	         The majority of the files required for the Windows operating system are 
                     contained here.
System, System32, 
    SysWOW64	    Contains all DLLs required for the core features of Windows and the Windows API. 
                    The operating system searches these folders any time a program asks to load a DLL 
                    without specifying an absolute path.
     WinSxS	        The Windows Component Store contains a copy of all Windows components, updates, 
                    and service packs. -->

<!-- Exploring Directories Using Command Line -->
<!-- We can explore the file system using the dir command. -->
C:\htb> dir c:\ /a
 Volume in drive C has no label.
 Volume Serial Number is F416-77BE

 Directory of c:\

08/16/2020  10:33 AM    <DIR>          $Recycle.Bin
06/25/2020  06:25 PM    <DIR>          $WinREAgent
07/02/2020  12:55 PM             1,024 AMTAG.BIN
06/25/2020  03:38 PM    <JUNCTION>     Documents and Settings [C:\Users]
08/13/2020  06:03 PM             8,192 DumpStack.log
08/17/2020  12:11 PM             8,192 DumpStack.log.tmp
08/27/2020  10:42 AM    37,752,373,248 hiberfil.sys
08/17/2020  12:11 PM    13,421,772,800 pagefile.sys
12/07/2019  05:14 AM    <DIR>          PerfLogs
08/24/2020  10:38 AM    <DIR>          Program Files
07/09/2020  06:08 PM    <DIR>          Program Files (x86)
08/24/2020  10:41 AM    <DIR>          ProgramData
06/25/2020  03:38 PM    <DIR>          Recovery
06/25/2020  03:57 PM             2,918 RHDSetup.log
08/17/2020  12:11 PM        16,777,216 swapfile.sys
08/26/2020  02:51 PM    <DIR>          System Volume Information
08/16/2020  10:33 AM    <DIR>          Users
08/17/2020  11:38 PM    <DIR>          Windows
               7 File(s) 51,190,943,590 bytes
              13 Dir(s)  261,310,697,472 bytes free
<!-- The tree utility is useful for graphically displaying the directory structure of a path or disk. -->
C:\htb> tree "c:\Program Files (x86)\VMware"
Folder PATH listing
Volume serial number is F416-77BE
C:\PROGRAM FILES (X86)\VMWARE
├───VMware VIX
│   ├───doc
│   │   ├───errors
│   │   ├───features
│   │   ├───lang
│   │   │   └───c
│   │   │       └───functions
│   │   └───types
│   ├───samples
│   └───Workstation-15.0.0
│       ├───32bit
│       └───64bit
└───VMware Workstation
    ├───env
    ├───hostd
    │   ├───coreLocale
    │   │   └───en
    │   ├───docroot
    │   │   ├───client
    │   │   └───sdk
    │   ├───extensions
    │   │   └───hostdiag
    │   │       └───locale
    │   │           └───en
    │   └───vimLocale
    │       └───en
    ├───ico
    ├───messages
    │   ├───ja
    │   └───zh_CN
    ├───OVFTool
    │   ├───env
    │   │   └───en
    │   └───schemas
    │       ├───DMTF
    │       └───vmware
    ├───Resources
    ├───tools-upgraders
    └───x64
<!-- The tree command can provide us with a large amount of information -->
<!-- The following command can be used to walk through all the files in the C drive, 
    one screen at a time.  -->
<!-- This command can be modified to be run against any directory. -->
tree c:\ /f | more


<!-- File System -->
<!-- There are 5 types of Windows file systems: FAT12, FAT16, FAT32, NTFS, and exFAT. -->
<!-- FAT12 and FAT16 are no longer used on modern Windows operating systems. -->
<!-- We will touch upon the FAT32 and exFAT file systems for this training, but our main focus 
    will be the NTFS file system. -->
<!-- FAT32 (File Allocation Table) is widely used across many types of storage devices such as USB 
    memory sticks and SD cards but can also be used to format hard drives. -->
<!-- The "32" in the name refers to the fact that FAT32 uses 32 bits of data for identifying data 
    clusters on a storage device. -->
<!-- Pros of FAT32: -->
<!-- Device compatibility - it can be used on computers, digital cameras, gaming consoles, 
    smartphones, tablets, and more.
Operating system cross-compatibility - It works on all Windows operating systems starting from 
Windows 95 and is also supported by MacOS and Linux. -->
<!-- Cons of FAT32 -->
<!-- Can only be used with files that are less than 4GB.
No built-in data protection or file compression features.
Must use third-party tools for file encryption. -->
<!-- NTFS (New Technology File System) is the default Windows file system since Windows NT 3.1 -->
<!-- In addition to making up for the shortcomings of FAT32, NTFS also has better support for metadata
     and better performance due to improved data structuring. -->
<!-- Pros of NTFS: -->
<!-- NTFS is reliable and can restore the consistency of the file system in the event of a system 
    failure or power loss.
Provides security by allowing us to set granular permissions on both files and folders.
Supports very large-sized partitions.
Has journaling built-in, meaning that file modifications (addition, modification, deletion) are logged. -->
<!-- Cons of NTFS: -->
<!-- Most mobile devices do not support NTFS natively.
Older media devices such as TVs and digital cameras do not offer support for NTFS storage devices. -->

<!-- Permissions -->
<!-- The NTFS file system has many basic and advanced permissions. Some of the key permission 
    types are: -->
<!--  Permission Type	              Description
       Full Control	      Allows reading, writing, changing, deleting of files/folders.
         Modify	          Allows reading, writing, and deleting of files/folders.
    List Folder Contents   Allows for viewing and listing folders and subfolders as well as executing
                          files. Folders only inherit this permission.
    Read and Execute	  Allows for viewing and listing files and subfolders as well as executing 
                          files. Files and folders inherit this permission.
         Write	          Allows for adding files to folders and subfolders and writing to a file.
         Read	          Allows for viewing and listing of folders and subfolders and viewing a 
                          file's contents.
    Traverse Folder	      This allows or denies the ability to move through folders to reach other 
                          files or folders. For example, a user may not have permission to list the 
                          directory contents or view files in the documents or web apps directory in 
                          this example c:\users\bsmith\documents\webapps\backups\backup_02042020.zip 
                          but with Traverse Folder permissions applied, they can access the backup 
                          archive. -->
<!-- Files and folders inherit the NTFS permissions of their parent folder for ease of administration,
     so administrators do not need to explicitly set permissions for each file and folder, as this 
     would be extremely time-consuming. -->
<!-- If permissions do need to be set explicitly, an administrator can disable permissions inheritance
     for the necessary files and folders and then set the permissions directly on each. -->

<!-- Integrity Control Access Control List (icacls) -->
<!-- NTFS permissions on files and folders in Windows can be managed using the File Explorer GUI 
    under the security tab -->
<!-- Apart from the GUI, we can also achieve a fine level of granularity over NTFS file permissions 
    in Windows from the command line using the icacls utility. -->
<!-- We can list out the NTFS permissions on a specific directory by running either icacls from 
    within the working directory or icacls C:\Windows against a directory not currently in. -->
C:\htb> icacls c:\windows
c:\windows NT SERVICE\TrustedInstaller:(F)
           NT SERVICE\TrustedInstaller:(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(M)
           NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
           BUILTIN\Administrators:(M)
           BUILTIN\Administrators:(OI)(CI)(IO)(F)
           BUILTIN\Users:(RX)
           BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
           CREATOR OWNER:(OI)(CI)(IO)(F)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
<!-- The resource access level is listed after each user in the output. The possible inheritance 
    settings are: -->
<!-- (CI): container inherit
(OI): object inherit
(IO): inherit only
(NP): do not propagate inherit
(I): permission inherited from parent container -->
<!-- In the above example, the NT AUTHORITY\SYSTEM account has object inherit, container inherit, 
    inherit only, and full access permissions. -->
<!-- This means that this account has full control over all file system objects in this directory 
    and subdirectories. -->
<!-- Basic access permissions are as follows: -->
<!-- F : full access
D :  delete access
N :  no access
M :  modify access
RX :  read and execute access
R :  read-only access
W :  write-only access -->
<!-- We can add and remove permissions via the command line using icacls. -->
<!-- Here we are executing icacls in the context of a local administrator account showing the C:\users
     directory where the joe user does not have any write permissions. -->
C:\htb> icacls c:\Users
c:\Users NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
<!-- Using the command icacls c:\users /grant joe:f we can grant the joe user full control over the 
    directory, but given that (oi) and (ci) were not included in the command, the joe user will only 
    have rights over the c:\users folder but not over the user subdirectories and files contained 
    within them. -->
C:\htb> icacls c:\users /grant joe:f
processed file: c:\users
Successfully processed 1 files; Failed processing 0 files

C:\htb> >icacls c:\users
c:\users WS01\joe:(F)
         NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
<!-- These permissions can be revoked using the command icacls c:\users /remove joe. -->
<!-- icacls is very powerful and can be used in a domain setting to give certain users or groups 
    specific permissions over a file or folder, explicitly deny access, enable or disable inheritance
     permissions, and change directory/file ownership. -->


<!-- NTFS vs. Share Permissions -->
<!-- The Server Message Block protocol (SMB) is used in Windows to connect shared resources like 
    files and printers. It is used in large, medium, and small enterprise environments. -->
<!-- NTFS permissions and share permissions are often understood to be the same. Please know that 
    they are not the same but often apply to the same shared resource. Let’s take a look at the 
    individual permissions that can be set to secure/grant objects access to a network share hosted 
    on a Windows OS running the NTFS file system. -->

<!-- Share permissions -->
<!--   Permission	         Description
      Full Control	        Users are permitted to perform all actions given by Change and Read 
                            permissions as well as change permissions for NTFS files and subfolders
        Change	            Users are permitted to read, edit, delete and add files and subfolders
         Read	            Users are allowed to view file & subfolder contents -->

<!-- NTFS Basic permissions -->
<!--   Permission	         Description
      Full Control	       Users are permitted to add, edit, move, delete files & folders as well as 
                           change NTFS permissions that apply to all allowed folders
        Modify	           Users are permitted or denied permissions to view and modify files and 
                           folders. This includes adding or deleting files
     Read & Execute	       Users are permitted or denied permissions to read the contents of files 
                           and execute programs
   List folder contents	   Users are permitted or denied permissions to view a listing of files and 
                           subfolders
         Read	           Users are permitted or denied permissions to read the contents of files
         Write	           Users are permitted or denied permissions to write changes to a file and 
                           add new files to a folder
   Special Permissions	   A variety of advanced permissions options -->

<!-- NTFS special permissions -->
<!--   Permission	             Description
      Full control	Users are permitted or denied permissions to add, edit, move, delete files & 
                    folders as well as change NTFS permissions that apply to all permitted folders
    Traverse folder / 
    execute file	Users are permitted or denied permissions to access a subfolder within a directory
                    structure even if the user is denied access to contents at the parent folder level.
                     Users may also be permitted or denied permissions to execute programs
 List folder/read data	    Users are permitted or denied permissions to view files and folders 
                            contained in the parent folder. Users can also be permitted to open and 
                            view files
    Read attributes	        Users are permitted or denied permissions to view basic attributes of a 
                            file or folder. Examples of basic attributes: system, archive, read-only,
                             and hidden
 Read extended attributes	Users are permitted or denied permissions to view extended attributes of 
                            a file or folder. Attributes differ depending on the program
  Create files/write data	Users are permitted or denied permissions to create files within a folder
                            and make changes to a file
 Create folders/append data	Users are permitted or denied permissions to create subfolders within a 
                            folder. Data can be added to files but pre-existing content cannot be 
                            overwritten
   Write attributes	        Users are permitted or denied to change file attributes. This permission 
                            does not grant access to creating files or folders
 Write extended attributes	Users are permitted or denied permissions to change extended attributes 
                            on a file or folder. Attributes differ depending on the program
 Delete subfolders and files	Users are permitted or denied permissions to delete subfolders and 
                                files. Parent folders will not be deleted
         Delete	            Users are permitted or denied permissions to delete parent folders, 
                            subfolders and files.
    Read permissions	    Users are permitted or denied permissions to read permissions of a folder
   Change permissions	    Users are permitted or denied permissions to change permissions of a 
                            file or folder
     Take ownership  	    Users are permitted or denied permission to take ownership of a file or 
                            folder. The owner of a file has full permissions to change any permissions-->
<!-- Keep in mind that NTFS permissions apply to the system where the folder and files are hosted. 
    Folders created in NTFS inherit permissions from parent folders by default. It is possible to 
    disable inheritance to set custom permissions on parent and subfolders, -->
<!-- The share permissions apply when the folder is being accessed through SMB, typically from a 
    different system over the network. This means someone logged in locally to the machine or via RDP
     can access the shared folder and files by simply navigating to the location on the file system 
     and only need to consider NTFS permissions. The permissions at the NTFS level provide 
     administrators much more granular control over what users can do within a folder or file. -->

<!-- Creating a Network Share -->
<!-- To get a solid fundamental understanding of SMB and it's relationship to NTFS, we will create 
    a network share on the Windows 10 target box. -->
<!-- In this case, we will create a shared folder by first creating a new folder on the Windows 10 
    desktop. Keep in mind that in most large enterprise environments, shares are created on a Storage
     Area Network (SAN), Network Attached Storage device (NAS), or a separate partition on drives 
     accessed via a server operating system like Windows Server -->
<!-- If we ever come across shares on a desktop operating system, it will either be a small business
     or it could be a beachhead system used by a penetration tester or malicious attacker to gather 
     and exfiltrate data. -->
<!-- We will go through this process using the GUI in Windows. -->
<!-- We are going to use the Advanced Sharing option to configure our share. -->
<!-- Notice how the share name automatically defaults to the name of the folder. Also, we can see 
    that it is possible to limit the number of users that can be connected to this share 
    simultaneously. In a real-world environment it is a good practice for administrators to set this 
    number according to the number of users that regularly need access to the resource being shared. -->
<!-- Similar to NTFS permissions, there is an access control list (ACL) for shared resources. We can 
    consider this the SMB permissions list. Keep in mind that with shared resources, both the SMB and
     NTFS permissions lists apply to every resource that gets shared in Windows -->
<!-- The ACL contains access control entries (ACEs). Typically these ACEs are made up of users & 
    groups (also called security principals) as they are a suitable mechanism for managing and 
    tracking access to shared resources. -->
<!-- Notice the default access control entry and permissions settings. -->
<!-- For now, we are going to apply these settings to test the effect of this ACL and the permissions
     applied as-is. We will test connectivity from the Pwnbox by opening terminal and using smbclient. -->
<!-- Note: A server is technically a software function used to service the requests of a client. In 
    this case, the Pwnbox is our client, and the Windows 10 target box is our server -->

<!-- Using smbclient to Connect to the Share -->
Warstone@htb[/htb]$ smbclient -L IPaddressOfTarget -U htb-student
Enter WORKGROUP\htb-student's password: 

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	Company Data    Disk      
	IPC$            IPC       Remote IPC
<!-- What could potentially block us from accessing this share if all our entries are correct and 
    our permissions list has the Everyone group present with at least Read permissions? -->

<!-- Windows Defender Firewall Considerations -->
<!-- It is the Windows Defender Firewall that could potentially be blocking access to the SMB share. 
    Since we are connecting from a Linux-based system the firewall has blocked access from any device
     that is not joined to the same workgroup. -->
<!-- It is also important to note that when a Windows system is part of a workgroup, all netlogon 
    requests are authenticated against that particular Windows system's SAM database. When a Windows 
    system is joined to a Windows Domain environment, all netlogon requests are authenticated against
     Active Directory. -->
<!--  The primary difference between a workgroup and a Windows Domain in terms of authentication, 
    is with a workgroup the local SAM database is used and in a Windows Domain a centralized 
    network-based database (Active Directory) is used. We must know this information when attempting 
    to logon & authenticate with a Windows system.  -->
<!-- In terms of the firewall blocking connections, this can be tested by completely deactivating 
    each firewall profile in Windows or by enabling specific predefined inbound firewall rules in 
    the Windows Defender Firewall advanced security settings. Like most firewalls, Windows Defender
     Firewall permits or denies traffic (access & connection requests in this case) flowing inbound 
     &/or outbound -->
<!-- The different inbound and outbound rules are associated with the different firewall profiles in 
    defender. -->
<!-- Windows Defender Firewall Profiles:
Public
Private
Domain -->
<!-- It is a best practice to enable predefined rules or add custom exceptions rather than 
    deactivating the firewall altogether. Unfortunately, it is very common for firewalls to be left 
    completely deactivated for the sake of convenience or lack of understanding. Firewall rules on 
    desktop systems can be centrally managed when joined to a Windows Domain environment through the 
    use of Group Policy. Group Policy concepts and configurations are outside of the scope of this 
    module. -->
<!-- Once the proper inbound firewall rules are enabled we will successfully connect to the share. 
    Keep in mind that we can only connect to the share because the user account we are using 
    (htb-student) is in the Everyone group. Recall that we left the specific share permissions for 
    the Everyone group set to Read, which quite literally means we will only be able to Read files 
    on this share. Once a connection is established with a share, we can create a mount point from 
    our Pwnbox to the Windows 10 target box's file system. This is where we must also consider that 
    NTFS permissions apply alongside share permissions. Recall that NTFS is the default file system 
    in Windows. Lets jump back to our xfreerdp session with our Windows 10 target box and take a look
     at the NTFS permissions on the Company Data folder. -->

<!-- NTFS Permissions ACL (Security Tab) -->
<!-- There's more granular control with NTFS permissions that can be applied to users and groups. 
    Anytime we see a gray checkmark next to a permission, it was inherited from a parent directory. 
    By default, all NTFS permissions are inherited from the parent directory. In the Windows world, 
    the C:\ drive is the parent directory to rule all directories unless a system administrator were 
    to disable inheritance inside a newly created folder’s advanced Security settings. -->
<!-- In many cases, the system administrator(s) of an organization would be responsible for deciding 
    what permissions a user or group of users gets over network resources. This is why many 
    spear-phishing attacks are directed at system administrators and other IT leaders. They have lots
     of influence over what is allowed in the environments they oversee, even more so than an 
     organization's non-technical c-level leaders in many cases. For example, the doctors or 
     executives working in a hospital will not have administrative rights over the network, but the 
     system administrators will. -->
<!-- Now lets give the Everyone group Full control at the share level and test the impact of the 
    change by trying to create a mount point to the share from the Desktop of our Pwnbox -->

<!-- Mounting to the Share -->
Warstone@htb[/htb]$ sudo mount -t cifs -o username=htb-student,password=Academy_WinFun! //ipaddoftarget/"Company Data" /home/user/Desktop/
<!-- If this command is not working check the syntax. If the syntax is correct yet the command is 
    still not working, cifs-utils may need to be installed. This can be done with the following 
    command: -->

<!-- Installing CIFS Utilities -->
Warstone@htb[/htb]$ sudo apt-get install cifs-utils
<!-- Once we have successfully created the mount point on the Desktop on our Pwnbox, we should look 
    at a couple of tools built-in to Windows that will allow us to track and monitor what we have done. -->
<!-- The net share command allows us to view all the shared folders on the system. Notice the share 
    we created and also the C:\ drive. -->
<!-- We didn't manually share C:. The most important drive with the most critical files on a Windows
     system is shared via SMB at install. This means anyone with the proper access could remotely 
     access the entire C:\ of each Windows system on a network. -->
<!-- We can also see the share we created. -->

<!-- Displaying Shares using net share -->
C:\Users\htb-student> net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share
IPC$                                         Remote IPC
ADMIN$       C:\WINDOWS                      Remote Admin
Company Data C:\Users\htb-student\Desktop\Company Data

The command completed successfully.
<!-- Computer Management is another tool we can use to identify and monitor shared resources on a 
    Windows system. -->

<!-- Monitoring Shares from Computer Management -->
<!-- We can poke around in Shares, Sessions, and Open Files to get an idea of what information this 
    provides us. Should there be a situation where we assist an individual or organization with 
    responding to a breach related to SMB, these are some great places to check and start to 
    understand how the breach may have happened and what may have been left behind. -->

<!-- Viewing Share access logs in Event Viewer -->
<!-- Event Viewer is another good place to investigate actions completed on Windows. Almost every 
    operating system has a logging mechanism and a utility to view the logs that were captured. Know 
    that a log is like a journal entry for a computer, where the computer writes down all the actions
     that were performed and numerous details associated with that action. We can view the logs 
     created for every action we performed when accessing the Windows 10 target box, as well as when
      creating, editing and accessing the shared folder. -->


<!-- Windows Services & Processes -->
<!-- Windows Services -->
<!-- Services are a major component of the Windows operating system. They allow for the creation and
     management of long-running processes. Windows services can be started automatically at system 
     boot without user intervention. These services can continue to run in the background even after 
     the user logs out of their account on the system. -->
<!-- Applications can also be created to install as a service, such as a network monitoring 
    application installed on a server. Services on Windows are responsible for many functions within 
    the Windows operating system, such as networking functions, performing system diagnostics, 
    managing user credentials, controlling Windows updates, and more. -->
<!-- Windows services are managed via the Service Control Manager (SCM) system, accessible via the 
    services.msc MMC add-in. -->
<!-- This add-in provides a GUI interface for interacting with and managing services and displays 
    information about each installed service. This information includes the service Name, Description,
     Status, Startup Type, and the user that the service runs under. -->
<!-- It is also possible to query and manage services via the command line using sc.exe using 
    PowerShell cmdlets such as Get-Service. -->
PS C:\htb> Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl


Name                : AdobeARMservice
DisplayName         : Adobe Acrobat Update Service
Status              : Running
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : True
ServiceType         : Win32OwnProcess

Name                : Appinfo
DisplayName         : Application Information
Status              : Running
DependentServices   : {}
ServicesDependedOn  : {RpcSs, ProfSvc}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : True
ServiceType         : Win32OwnProcess, Win32ShareProcess
<!-- Service statuses can appear as Running, Stopped, or Paused, and they can be set to start manually
    , automatically, or on a delay at system boot. Services can also be shown in the state of Starting
     or Stopping if some action has triggered them to either start or stop. -->
<!-- Windows has three categories of services: Local Services, Network Services, and System Services.
     Services can usually only be created, modified, and deleted by users with administrative 
     privileges. Misconfigurations around service permissions are a common privilege escalation 
     vector on Windows systems. -->
<!-- In Windows, we have some critical system services that cannot be stopped and restarted without
     a system restart. If we update any file or resource in use by one of these services, we must 
     restart the system. -->
<!--       Service	                     Description
          smss.exe	       Session Manager SubSystem. Responsible for handling sessions on the system.
          csrss.exe	       Client Server Runtime Process. The user-mode portion of the Windows 
                           subsystem.
         wininit.exe	   Starts the Wininit file .ini file that lists all of the changes to be 
                           made to Windows when the computer is restarted after installing a program.
         logonui.exe	   Used for facilitating user login into a PC
          lsass.exe	       The Local Security Authentication Server verifies the validity of user 
                           logons to a PC or server. It generates the process responsible for 
                           authenticating users for the Winlogon service.
        services.exe	   Manages the operation of starting and stopping services.
        winlogon.exe	   Responsible for handling the secure attention sequence, loading a user 
                           profile on logon, and locking the computer when a screensaver is running.
            System	       A background system process that runs the Windows kernel.
    svchost.exe with RPCSS	Manages system services that run from dynamic-link libraries (files with 
                           the extension .dll) such as "Automatic Updates," "Windows Firewall," and 
                           "Plug and Play." Uses the Remote Procedure Call (RPC) Service (RPCSS).
  svchost.exe with Dcom/PnP	Manages system services that run from dynamic-link libraries (files with 
                           the extension .dll) such as "Automatic Updates," "Windows Firewall," and 
                           "Plug and Play." Uses the Distributed Component Object Model (DCOM) and 
                           Plug and Play (PnP) services.-->

<!-- Processes -->
<!-- Processes run in the background on Windows systems. They either run automatically as part of 
    the Windows operating system or are started by other installed applications. -->
<!-- Processes associated with installed applications can often be terminated without causing a 
    severe impact on the operating system. Certain processes are critical and, if terminated, will 
    stop certain components of the operating system from running properly. Some examples include the 
    Windows Logon Application, System, System Idle Process, Windows Start-Up Application, Client 
    Server Runtime, Windows Session Manager, Service Host, and Local Security Authority Subsystem 
    Service (LSASS) process. -->

<!-- Local Security Authority Subsystem Service (LSASS) -->
<!-- lsass.exe is the process that is responsible for enforcing the security policy on Windows 
    systems. When a user attempts to log on to the system, this process verifies their log on attempt
     and creates access tokens based on the user's permission levels. LSASS is also responsible for 
     user account password changes -->
<!-- All events associated with this process (logon/logoff attempts, etc.) are logged within the 
    Windows Security Log. LSASS is an extremely high-value target as several tools exist to extract 
    both cleartext and hashed credentials stored in memory by this process. -->

<!-- Sysinternals Tools -->
<!-- The SysInternals Tools suite is a set of portable Windows applications that can be used to 
    administer Windows systems (for the most part without requiring installation) -->
<!-- The tools can be either downloaded from the Microsoft website or by loading them directly from 
    an internet-accessible file share by typing \\live.sysinternals.com\tools into a Windows Explorer
     window. -->
<!-- For example, we can run procdump.exe directly from this share without downloading it directly to
     disk. -->
C:\htb> \\live.sysinternals.com\tools\procdump.exe -accepteula

ProcDump v9.0 - Sysinternals process dump utility
Copyright (C) 2009-2017 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

Monitors a process and writes a dump file when the process exceeds the
specified criteria or has an exception.

Capture Usage:
   procdump.exe [-mm] [-ma] [-mp] [-mc Mask] [-md Callback_DLL] [-mk]
                [-n Count]
                [-s Seconds]
                [-c|-cl CPU_Usage [-u]]
                [-m|-ml Commit_Usage]
                [-p|-pl Counter_Threshold]
                [-h]
                [-e [1 [-g] [-b]]]
                [-l]
                [-t]
                [-f  Include_Filter, ...]
                [-fx Exclude_Filter, ...]
                [-o]
                [-r [1..5] [-a]]
                [-wer]
                [-64]
                {
                 {{[-w] Process_Name | Service_Name | PID} [Dump_File | Dump_Folder]}
                |
                 {-x Dump_Folder Image_File [Argument, ...]}
                }
				
<SNIP>
<!-- The suite includes tools such as Process Explorer, an enhanced version of Task Manager, and 
    Process Monitor, which can be used to monitor file system, registry, and network activity related
     to any process running on the system -->
<!-- Some additional tools are TCPView, which is used to monitor internet activity, and PSExec, which
     can be used to manage/connect to systems via the SMB protocol remotely. -->
<!-- These tools can be useful for penetration testers to, for example, discover interesting processes
     and possible privilege escalation paths as well as for lateral movement. -->

<!-- Task Manager -->
<!-- Windows Task Manager is a powerful tool for managing Windows systems. It provides information 
    about running processes, system performance, running services, startup programs, logged-in 
    users/logged in user processes, and services. -->
<!-- Task Manager can be opened by right-clicking on the taskbar and selecting Task Manager, 
    pressing ctrl + shift + Esc, pressing ctrl + alt + del and selecting Task Manager, opening the 
    start menu and typing Task Manager, or typing taskmgr from a CMD or PowerShell console. -->
<!--         Tab	                Description
        Processes tab	       Shows a list of running applications and background processes along 
                               with the CPU, memory, disk, network, and power usage for each.
       Performance tab	       Shows graphs and data such as CPU utilization, system uptime, memory 
                               usage, disk and, networking, and GPU usage. We can also open the 
                               Resource Monitor, which gives us a much more in-depth view of the 
                               current CPU, Memory, Disk, and Network resource usage. -->
<!--         Tab	                Description
       App history tab	       Shows resource usage for the current user account for each application
                               for a period of time.
         Startup tab	       Shows which applications are configured to start at boot as well as the
                               impact on the startup process.
          Users tab	           Shows logged in users and the processes/resource usage associated with
                               their session.
         Details tab	       Shows the name, process ID (PID), status, associated username, CPU, and
                               memory usage for each running application.
        Services tab	       Shows the name, PID, description, and status of each installed service.
                               The Services add-in can be accessed from this tab as well.-->

<!-- Process Explorer -->                  
<!-- Process Explorer is a part of the Sysinternals tool suite. This tool can show which handles and 
    DLL(dynamic link library) processes are loaded when a program runs. Process Explorer shows a list of currently running 
    processes, and from there, we can see what handles the process has selected in one view or the 
    DLLs and memory-swapped files that have been loaded in another view. -->
<!--  We can also search within the tool to show which processes tie back to a specific handle or DLL.
     The tool can also be used to analyze parent-child process relationships to see what child 
     processes are spawned by an application and help troubleshoot any issues such as orphaned 
     processed that can be left behind when a process is terminated. -->
<!-- dynamic link library -->
<!-- A dynamic link library (DLL) is a collection of small programs that larger programs can load 
    when needed to complete specific tasks. The small program, called a DLL file, contains 
    instructions that help the larger program handle what may not be a core function of the original
     program. -->


<!-- Service Permissions -->
<!-- The first step in realizing the importance of service permissions is simply understanding that 
    they exist and being mindful of them. On server operating systems, critical network services like
     DHCP and Active Directory Domain Services commonly get installed using the account assigned to 
     the admin performing the install. Part of the install process includes assigning a specific 
     service to run using the credentials and privileges of a designated user, which by default is 
     set within the currently logged-on user context. -->
<!-- Dynamic Host Configuration Protocol (DHCP) is a network protocol used to automate the process 
    of configuring devices on IP networks, thus allowing them to use network services such as DNS, 
    NTP, and any communication protocol based on UDP or TCP. -->
<!-- For example, if we are logged on as Bob on a server during DHCP install, then that service will 
    be configured to run as Bob unless specified otherwise. What bad things could come of this? Well,
     what if Bob leaves the organization or gets fired? The typical business practice would be to 
     disable Bob’s account as part of his exit process. In this case, what would happen to DHCP and 
     other services running using Bob’s account? Those services would fail to start. DHCP or Dynamic
      Host Configuration Protocol is responsible for leasing IP addresses to computers on the network.
       If this service stops on a Windows DHCP server, clients requesting an IP address will not 
       receive one. This means a service misconfiguration could lead to downtime and loss of 
       productivity. It is highly recommended to create an individual user account to run critical
        network services. These are referred to as service accounts. -->
<!-- We should also be mindful of service permissions and the permissions of the directories they 
    execute from because it is possible to replace the path to an executable with a malicious DLL or 
    executable file. Let's examine the permissions of services running on Windows 10 to get an even
    better understanding of this. -->

<!-- Examining Services using services.msc -->
<!-- As discussed in the processes and services section, we can use services.msc to view and manage 
    just about every detail regarding all services. Let's take a closer look at the service associated
     with Windows Update (wuauserv). -->
<!-- Make a note of the different properties available for viewing and configuration. Knowing the 
    service name is especially useful when using command-line tools to examine and manage services.
    Path to the executable is the full path to the program and command to execute when the service 
    starts. If the NTFS permissions of the destination directory are configured with weak permissions,
     an attacker could replace the original executable with one created for malicious purposes. -->
<!-- Most services run with LocalSystem privileges by default which is the highest level of access 
    allowed on an individual Windows OS. Not all applications need Local System account-level 
    permissions, so it is beneficial to perform research on a case-by-case basis when considering 
    installing new applications in a Windows environment. It is a good practice to identify 
    applications that can run with the least privileges possible to align with the principle of 
    least privilege. -->
<!-- Notable built-in service accounts in Windows: -->
<!-- LocalService

NetworkService

LocalSystem -->
<!-- Note: We can also create new accounts and use them for the sole purpose of running a service. -->
<!-- The recovery tab allows steps to be configured should a service fail. Notice how this service 
    can be set to run a program after the first failure. This is yet another vector that an attacker
     could use to run malicious programs by utilizing a legitimate service. -->

<!-- Examining services using sc -->
<!-- Sc can also be used to configure and manage services. Let's experiment with a few commands. -->
C:\Users\htb-student>sc qc wuauserv
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\WINDOWS\system32\svchost.exe -k netsvcs -p
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
<!-- The sc qc command is used to query the service. This is where knowing the names of services can 
    come in handy. If we wanted to query a service on a device over the network, we could specify the
     hostname or IP address immediately after sc -->
C:\Users\htb-student>sc //hostname or ip of box query ServiceName
<!-- We can also use sc to start and stop services. -->
C:\Users\htb-student> sc stop wuauserv

[SC] OpenService FAILED 5:

Access is denied.
<!-- Notice how we are denied access from performing this action without running it within an 
    administrative context. If we run a command prompt with elevated privileges, we will be permitted
     to complete this action. -->
C:\WINDOWS\system32> sc config wuauserv binPath=C:\Winbows\Perfectlylegitprogram.exe

[SC] ChangeServiceConfig SUCCESS

C:\WINDOWS\system32> sc qc wuauserv

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Winbows\Perfectlylegitprogram.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
<!-- If we were investigating a situation where we suspected that the system had malware, sc would 
    give us the ability to quickly search and analyze commonly targeted services and newly created 
    services. It’s also much more script-friendly than utilizing GUI tools like services.msc. -->
<!-- Another helpful way we can examine service permissions using sc is through the sdshow command. -->
C:\WINDOWS\system32> sc sdshow wuauserv

D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)S:(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)
<!-- At an initial glance, the output looks crazy. It almost seems that we have done something wrong 
    in our command, but there is a meaning to this madness. Every named object in Windows is a 
    securable object, and even some unnamed objects are securable. If it's securable in a Windows OS,
     it will have a security descriptor. Security descriptors identify the object’s owner and a 
     primary group containing a Discretionary Access Control List (DACL) and a System Access Control 
     List (SACL). -->
<!-- Generally, a DACL is used for controlling access to an object, and a SACL is used to account for
     and log access attempts. This section will examine the DACL, but the same concepts would apply 
     to a SACL. -->
D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)
<!-- This amalgamation of characters crunched together and delimited by opened and closed parentheses
     is in a format known as the Security Descriptor Definition Language (SDDL). -->
<!-- We may be tempted to read from left to right because that is how the English language is 
    typically written, but it can be much different when interacting with computers. Read the entire 
    security descriptor for the Windows Update (wuauserv) service in this order starting with the 
    first letter and set of parentheses: -->
<!-- Securable Objects: A securable object is an object that can have a security descriptor.A 
    security descriptor contains the security information associated with a securable object. A 
    security descriptor consists of a SECURITY_DESCRIPTOR structure and its associated security 
    information. A security descriptor can include the following security information:

Security identifiers (SIDs) for the owner and primary group of an object.
A DACL that specifies the access rights allowed or denied to particular users or groups.
A SACL that specifies the types of access attempts that generate audit records for the object.
A set of control bits that qualify the meaning of a security descriptor or its individual members. -->
D: (A;;CCLCSWRPLORC;;;AU)
<!-- D: - the proceeding characters are DACL permissions
AU: - defines the security principal Authenticated Users
A;; - access is allowed
CC - SERVICE_QUERY_CONFIG is the full name, and it is a query to the service control manager (SCM) 
for the service configuration
LC - SERVICE_QUERY_STATUS is the full name, and it is a query to the service control manager (SCM) 
for the current status of the service
SW - SERVICE_ENUMERATE_DEPENDENTS is the full name, and it will enumerate a list of dependent services
RP - SERVICE_START is the full name, and it will start the service
LO - SERVICE_INTERROGATE is the full name, and it will query the service for its current status
RC - READ_CONTROL is the full name, and it will query the security descriptor of the service -->
<!-- As we read the security descriptor, it can be easy to get lost in the seemingly random order of 
    characters, but recall that we are essentially viewing access control entries in an access control
     list. Each set of 2 characters in between the semi-colons represents actions allowed to be 
     performed by a specific user or group. -->
;;CCLCSWRPLORC;;;
<!-- After the last set of semi-colons, the characters specify the security principal (User and/or 
    Group) that is permitted to perform those actions. -->
;;;AU
<!-- The character immediately after the opening parentheses and before the first set of semi-colons 
    defines whether the actions are Allowed or Denied. -->
A;;
<!-- This entire security descriptor associated with the Windows Update (wuauserv) service has three 
    sets of access control entries because there are three different security principals. Each 
    security principal has specific permissions applied. -->

<!-- Examine service permissions using PowerShell -->
<!-- Using the Get-Acl PowerShell cmdlet, we can examine service permissions by targeting the path 
    of a specific service in the registry. -->
PS C:\Users\htb-student> Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\wuauserv
Owner  : NT AUTHORITY\SYSTEM
Group  : NT AUTHORITY\SYSTEM
Access : BUILTIN\Users Allow  ReadKey
         BUILTIN\Users Allow  -2147483648
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadKey
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -2147483648
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         ReadKey
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         -2147483648
Audit  :
Sddl   : O:SYG:SYD:AI(A;ID;KR;;;BU)(A;CIIOID;GR;;;BU)(A;ID;KA;;;BA)(A;CIIOID;GA;;;BA)(A;ID;KA;;;SY)(A;CIIOID;GA;;;SY)(A
         ;CIIOID;GA;;;CO)(A;ID;KR;;;AC)(A;CIIOID;GR;;;AC)(A;ID;KR;;;S-1-15-3-1024-1065365936-1281604716-3511738428-1654
         721687-432734479-3232135806-4053264122-3456934681)(A;CIIOID;GR;;;S-1-15-3-1024-1065365936-1281604716-351173842
         8-1654721687-432734479-3232135806-4053264122-3456934681)
<!-- Notice how this command returns specific account permissions in an easy-to-read format and in 
    SDDL. Also, the SID that represents each security principal (User and/or Group) is present in the
     SDDL. This is something we do not get when running sc from the command prompt. -->
<!-- The security descriptor definition language (SDDL) provides syntax for defining conditional ACEs
     in a string format. Explains the strings used in an access control entry (ACE). The Security 
     Descriptor String Format is a text format for storing or transporting information in a security 
     descriptor. -->


<!-- Windows Sessions -->
<!-- Interactive -->
<!-- An interactive, or local logon session, is initiated by a user authenticating to a local or 
    domain system by entering their credentials. An interactive logon can be initiated by logging 
    directly into the system, by requesting a secondary logon session using the runas command via 
    the command line, or through a Remote Desktop connection. -->

<!-- Non-interactive -->
<!-- Non-interactive accounts in Windows differ from standard user accounts as they do not require 
    login credentials. There are 3 types of non-interactive accounts: the Local System Account, Local
     Service Account, and the Network Service Account. Non-interactive accounts are generally used 
     by the Windows operating system to automatically start services and applications without 
     requiring user interaction. These accounts have no password associated with them and are usually
      used to start services when the system boots or to run scheduled tasks. -->
<!-- There are differences between the three types of accounts: -->
<!--          Account	                             Description
       Local System Account	             Also known as the NT AUTHORITY\SYSTEM account, this is the 
                                         most powerful account in Windows systems. It is used for a 
                                         variety of OS-related tasks, such as starting Windows 
                                         services. This account is more powerful than accounts in the
                                          local administrators group.
       Local Service Account	         Known as the NT AUTHORITY\LocalService account, this is a 
                                         less privileged version of the SYSTEM account and has similar
                                          privileges to a local user account. It is granted limited 
                                          functionality and can start some services.
      Network Service Account	         This is known as the NT AUTHORITY\NetworkService account and
                                         is similar to a standard domain user account. It has similar
                                          privileges to the Local Service Account on the local machine.
                                           It can establish authenticated sessions for certain network
                                            services. -->
































